#!/bin/bash -e

# Enable jemalloc for reduced memory usage and latency.
if [ -z "${LD_PRELOAD+x}" ]; then
    LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
    export LD_PRELOAD
fi

# If running the rails server then create or migrate existing database
if [ "${*: -3:1}" == "puma" ]; then
  # Handle collation mismatches from updating the docker image
  PGPASSWORD="${DATABASE_PASSWORD}" psql -U "${DATABASE_USER}" -h "${DATABASE_HOST}" -d postgres -c "REINDEX DATABASE postgres;" -c "ALTER DATABASE postgres REFRESH COLLATION VERSION;"
  PGPASSWORD="${DATABASE_PASSWORD}" psql -U "${DATABASE_USER}" -h "${DATABASE_HOST}" -d template1 -c "REINDEX DATABASE template1;" -c "ALTER DATABASE template1 REFRESH COLLATION VERSION;"
  PGPASSWORD="${DATABASE_PASSWORD}" psql -U "${DATABASE_USER}" -h "${DATABASE_HOST}" -d "${DATABASE_USER}" -c "REINDEX DATABASE \"${DATABASE_USER}\";" -c "ALTER DATABASE \"${DATABASE_USER}\" REFRESH COLLATION VERSION;"

  bundle exec hanami db prepare --env=production
fi

exec "${@}"
