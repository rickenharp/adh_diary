#!/bin/bash -e

# Enable jemalloc for reduced memory usage and latency.
if [ -z "${LD_PRELOAD+x}" ]; then
    LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
    export LD_PRELOAD
fi

# If running the rails server then create or migrate existing database
if [ "${*: -3:1}" == "puma" ]; then
  # Handle collation mismatches from updating the docker image
  psql "postgres://postgres@${DATABASE_HOST}/postgres" -c "REINDEX DATABASE postgres;" -c "ALTER DATABASE postgres REFRESH COLLATION VERSION;"
  psql "postgres://postgres@${DATABASE_HOST}/template1" -c "REINDEX DATABASE template1;" -c "ALTER DATABASE template1 REFRESH COLLATION VERSION;"
  psql "${DATABASE_URL}" -c "REINDEX DATABASE adh_diary;" -c "ALTER DATABASE adh_diary REFRESH COLLATION VERSION;"

  bundle exec hanami db prepare --env=production
fi

exec "${@}"
